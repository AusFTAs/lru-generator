<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lru-generator/src/index.js | lru-generator</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Least recently used cached generator"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="lru-generator"><meta property="twitter:description" content="Least recently used cached generator"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/nahidakbar/lru-generator"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#src">src</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generator">generator</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lru-generator/src/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * @file LRU cached generator utility.
 *
 * @author Nahid Akbar
 * @year 2016
 * @copyright National ICT Australia (NICTA). All rights reserved.
 */

&quot;use strict&quot;;

const stringify = require(&apos;json-stable-stringify&apos;);

//
// function print(t)
// {
//   while (t !== undefined)
//   {
//     console.log(&apos;item&apos;, t.key,
//       t.prev ? &apos;prev&apos; : &apos;&apos;, t.prev ? t.prev.key : &apos;&apos;,
//       t.next ? &apos;next&apos; : &apos;&apos;, t.next ? t.next.key : &apos;&apos;);
//     t = t.next;
//   }
// }
//
function generator(limit, global_generate, options)
{
  options = options || {};

  limit = Math.max(1, limit);
  var index = {};
  var top = {
    next: null,
    key: &apos;top&apos;
  };
  var bottom = {
    prev: top,
    key: &apos;bottom&apos;
  };
  top.next = bottom;
  var count = 0;

  function isCached(key)
  {
    return index[key] !== undefined;
  }

  function getCached(key)
  {
    var i = index[key];
    if (i !== undefined)
    {
      var n = i.next,
        p = i.prev;
      if (i.key !== top.next.key)
      {
        p.next = n;
        n.prev = p;
        top.next.prev = i;
        i.next = top.next;
        top.next = i;
      }
      return top.next.item;
    }
  }

  function cache(key, value)
  {
    var n = index[key] = {
      next: top.next,
      prev: top,
      item: value,
      key: key
    };
    top.next.prev = n;
    top.next = n;
    if (++count &gt; limit)
    {
      var i = bottom.prev;
      i.prev.next = i.next;
      i.next.prev = i.prev;
      delete index[i.key];
      count--;
    }
  }

  function purge(key)
  {
    var i = index[key];
    if (i !== undefined)
    {
      i.prev.next = i.next;
      i.next.prev = i.prev
      delete index[key];
      count--;
    }
  }

  function sync_generate(key, local_generate)
  {
    const originalKey = key;
    if (typeof key !== &apos;string&apos;)
    {
      key = stringify(key);
    }
    if (index[key] !== undefined)
    {
      return getCached(key);
    }
    else
    {
      const value = (local_generate || global_generate)(originalKey, key);
      cache(key, value);
      return value;
    }
  }

  function async_generate(key, callback, local_generate)
  {
    if (index[key] !== undefined)
    {
      callback(getCached(key));
    }
    else
    {
      (local_generate || global_generate)(key, function (value)
      {
        cache(key, value);
        callback(value);
      });
    }
  }

  var result = options.async ? async_generate : sync_generate;
  result.sync = sync_generate;
  result.async = async_generate;
  result.cache = cache;
  result.purge = purge;
  result.isCached = isCached;
  result.getCached = getCached;
  return result;
}

module.exports = generator;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
